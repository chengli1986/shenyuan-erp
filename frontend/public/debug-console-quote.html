<!DOCTYPE html>
<html>
<head>
    <title>Consoleè°ƒè¯• - è¯¢ä»·åŠŸèƒ½</title>
    <style>
        body { 
            font-family: Arial; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 6px;
            background: #fafafa;
        }
        input, textarea, select { 
            width: 100%; 
            max-width: 300px;
            margin: 5px 0; 
            padding: 8px; 
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button { 
            padding: 10px 20px; 
            margin: 10px 5px; 
            background: #1890ff; 
            color: white; 
            border: none; 
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.3s;
        }
        button:hover { background: #40a9ff; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .error { color: #ff4d4f; font-weight: bold; }
        .success { color: #52c41a; font-weight: bold; }
        .warning { color: #faad14; font-weight: bold; }
        .info { color: #1890ff; }
        .log { 
            background: #000; 
            color: #0f0; 
            padding: 15px; 
            margin: 10px 0; 
            white-space: pre-wrap; 
            font-family: 'Courier New', monospace;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        .step-title {
            background: #e6f7ff;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #1890ff;
            font-weight: bold;
        }
        .form-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 10px 0;
        }
        .form-row label {
            min-width: 100px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Consoleè°ƒè¯• - è¯¢ä»·åŠŸèƒ½</h1>
        <p>è¿™ä¸ªé¡µé¢ä¼šæä¾›è¯¦ç»†çš„consoleæ—¥å¿—æ¥å¸®åŠ©è°ƒè¯•å‰ç«¯è¯¢ä»·æäº¤é—®é¢˜</p>
        
        <div class="section">
            <div class="step-title">æ­¥éª¤1: ç™»å½•é‡‡è´­å‘˜è´¦å·</div>
            <button onclick="loginPurchaser()">ç™»å½•é‡‡è´­å‘˜ (purchaser)</button>
            <div id="loginStatus"></div>
        </div>
        
        <div class="section">
            <div class="step-title">æ­¥éª¤2: è·å–å¾…è¯¢ä»·ç”³è´­å•</div>
            <button onclick="getSubmittedRequests()">è·å–å¾…è¯¢ä»·åˆ—è¡¨</button>
            <div id="requestList"></div>
        </div>
        
        <div class="section">
            <div class="step-title">æ­¥éª¤3: æ¨¡æ‹Ÿå‰ç«¯è¡¨å•æäº¤</div>
            <div class="form-row">
                <label>ç”³è´­å•ID:</label>
                <input type="text" id="requestId" value="66">
                <button onclick="getRequestDetail()">è·å–è¯¦æƒ…</button>
            </div>
            <div id="requestDetail"></div>
            
            <h4>è¯¢ä»·è¡¨å•æ•°æ®:</h4>
            <div class="form-row">
                <label>ç‰©æ–™ID:</label>
                <input type="text" id="itemId" value="">
            </div>
            <div class="form-row">
                <label>å•ä»·:</label>
                <input type="number" id="unitPrice" value="1200">
            </div>
            <div class="form-row">
                <label>ä¾›åº”å•†:</label>
                <input type="text" id="supplierName" value="Consoleæµ‹è¯•ä¾›åº”å•†">
            </div>
            <div class="form-row">
                <label>è”ç³»äºº:</label>
                <input type="text" id="contactPerson" value="å¼ ç»ç†">
            </div>
            <div class="form-row">
                <label>è”ç³»æ–¹å¼:</label>
                <input type="text" id="contact" value="13900139000">
            </div>
            <div class="form-row">
                <label>ä»˜æ¬¾æ–¹å¼:</label>
                <input type="text" id="paymentMethod" value="æœˆç»“45å¤©">
            </div>
            <div class="form-row">
                <label>é¢„è®¡åˆ°è´§:</label>
                <input type="date" id="deliveryDate" value="2025-09-20">
            </div>
            <div class="form-row">
                <label>è¯¢ä»·å¤‡æ³¨:</label>
                <textarea id="notes" rows="3">Consoleè°ƒè¯•æµ‹è¯•è¯¢ä»·</textarea>
            </div>
            
            <button onclick="submitQuoteWithConsole()" style="background: #52c41a;">ğŸ“‹ æäº¤è¯¢ä»· (è¯¦ç»†æ—¥å¿—)</button>
            <button onclick="clearLogs()" style="background: #faad14;">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
            
            <div id="quoteResult"></div>
        </div>
        
        <div class="section">
            <div class="step-title">Consoleè¾“å‡ºæ—¥å¿—</div>
            <div id="consoleLog" class="log">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>
    
    <script>
        let token = '';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                error: '#ff4d4f',
                success: '#52c41a', 
                warning: '#faad14',
                info: '#0ff',
                debug: '#ff0'
            };
            const color = colors[type] || '#0f0';
            
            logDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // åŒæ—¶è¾“å‡ºåˆ°browser console
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLogs() {
            document.getElementById('consoleLog').innerHTML = '';
        }
        
        async function loginPurchaser() {
            try {
                log('ğŸ” å¼€å§‹ç™»å½•é‡‡è´­å‘˜è´¦å·...', 'info');
                
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'username=purchaser&password=purchase123'
                });
                
                log(`ğŸ“¡ ç™»å½•å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, 'debug');
                
                const data = await response.json();
                log(`ğŸ“‹ ç™»å½•å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'debug');
                
                if (response.ok && data.access_token) {
                    token = data.access_token;
                    document.getElementById('loginStatus').innerHTML = 
                        `<span class="success">âœ… ç™»å½•æˆåŠŸ: ${data.user.name} (${data.user.role})</span>`;
                    log(`âœ… Tokenè·å–æˆåŠŸ: ${token.substring(0, 20)}...`, 'success');
                } else {
                    document.getElementById('loginStatus').innerHTML = 
                        `<span class="error">âŒ ç™»å½•å¤±è´¥</span>`;
                    log(`âŒ ç™»å½•å¤±è´¥: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                log(`ğŸ’¥ ç™»å½•å¼‚å¸¸: ${error.message}`, 'error');
                log(`ğŸ” å¼‚å¸¸å †æ ˆ: ${error.stack}`, 'error');
                document.getElementById('loginStatus').innerHTML = 
                    `<span class="error">âŒ ç™»å½•å¼‚å¸¸: ${error.message}</span>`;
            }
        }
        
        async function getSubmittedRequests() {
            if (!token) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            try {
                log('ğŸ“‹ è·å–å¾…è¯¢ä»·ç”³è´­å•åˆ—è¡¨...', 'info');
                
                const response = await fetch('/api/v1/purchases/?status=submitted', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                log(`ğŸ“¡ ç”³è´­å•åˆ—è¡¨å“åº”: ${response.status} ${response.statusText}`, 'debug');
                
                const data = await response.json();
                log(`ğŸ“‹ ç”³è´­å•æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'debug');
                
                if (response.ok) {
                    const items = data.items || [];
                    let html = `<h4>å¾…è¯¢ä»·ç”³è´­å• (${items.length}æ¡)</h4><ul>`;
                    items.forEach(item => {
                        html += `<li><strong>${item.request_code}</strong> - ${item.project_name || 'N/A'} (ID: ${item.id})</li>`;
                    });
                    html += '</ul>';
                    document.getElementById('requestList').innerHTML = html;
                    
                    log(`âœ… æ‰¾åˆ° ${items.length} ä¸ªå¾…è¯¢ä»·ç”³è´­å•`, 'success');
                    
                    // è‡ªåŠ¨å¡«å……PR202508200001
                    const targetRequest = items.find(item => item.request_code === 'PR202508200001');
                    if (targetRequest) {
                        document.getElementById('requestId').value = targetRequest.id;
                        log(`ğŸ¯ è‡ªåŠ¨é€‰æ‹©ç›®æ ‡ç”³è´­å•: ${targetRequest.request_code} (ID: ${targetRequest.id})`, 'success');
                    }
                } else {
                    log(`âŒ è·å–å¤±è´¥: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                log(`ğŸ’¥ è·å–å¼‚å¸¸: ${error.message}`, 'error');
                log(`ğŸ” å¼‚å¸¸å †æ ˆ: ${error.stack}`, 'error');
            }
        }
        
        async function getRequestDetail() {
            const requestId = document.getElementById('requestId').value;
            if (!token || !requestId) {
                alert('è¯·å…ˆç™»å½•å¹¶å¡«å†™ç”³è´­å•ID');
                return;
            }
            
            try {
                log(`ğŸ“‹ è·å–ç”³è´­å• ${requestId} è¯¦æƒ…...`, 'info');
                
                const response = await fetch(`/api/v1/purchases/${requestId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                log(`ğŸ“¡ è¯¦æƒ…å“åº”: ${response.status} ${response.statusText}`, 'debug');
                
                const data = await response.json();
                log(`ğŸ“‹ è¯¦æƒ…æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'debug');
                
                if (response.ok && data.items && data.items.length > 0) {
                    const firstItem = data.items[0];
                    document.getElementById('itemId').value = firstItem.id;
                    
                    let html = `<h4>ç”³è´­å•è¯¦æƒ…</h4>`;
                    html += `<p><strong>ç¼–å·:</strong> ${data.request_code}</p>`;
                    html += `<p><strong>çŠ¶æ€:</strong> ${data.status}</p>`;
                    html += `<p><strong>æ˜ç»†é¡¹æ•°é‡:</strong> ${data.items.length}</p>`;
                    html += `<p><strong>ç¬¬ä¸€é¡¹:</strong> ${firstItem.item_name} (ID: ${firstItem.id})</p>`;
                    
                    document.getElementById('requestDetail').innerHTML = html;
                    log(`âœ… è‡ªåŠ¨å¡«å……ç‰©æ–™ID: ${firstItem.id} (${firstItem.item_name})`, 'success');
                } else {
                    log(`âŒ è·å–è¯¦æƒ…å¤±è´¥æˆ–æ— æ˜ç»†é¡¹`, 'error');
                }
            } catch (error) {
                log(`ğŸ’¥ è·å–è¯¦æƒ…å¼‚å¸¸: ${error.message}`, 'error');
                log(`ğŸ” å¼‚å¸¸å †æ ˆ: ${error.stack}`, 'error');
            }
        }
        
        async function submitQuoteWithConsole() {
            if (!token) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            const requestId = document.getElementById('requestId').value;
            const itemId = document.getElementById('itemId').value;
            const unitPrice = parseFloat(document.getElementById('unitPrice').value);
            const supplierName = document.getElementById('supplierName').value;
            const contactPerson = document.getElementById('contactPerson').value;
            const contact = document.getElementById('contact').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            const notes = document.getElementById('notes').value;
            
            log('ğŸš€ å¼€å§‹æäº¤è¯¢ä»·...', 'info');
            log(`ğŸ“‹ ç”³è´­å•ID: ${requestId}`, 'debug');
            log(`ğŸ“‹ ç‰©æ–™ID: ${itemId}`, 'debug');
            
            // æ„å»ºè¯¢ä»·æ•°æ® - æ¨¡æ‹Ÿå‰ç«¯Reactè¡¨å•çš„æ•°æ®ç»“æ„
            const quoteData = {
                quote_notes: notes,
                items: [{
                    item_id: parseInt(itemId),
                    unit_price: unitPrice,
                    supplier_name: supplierName,
                    supplier_contact: contact,
                    supplier_contact_person: contactPerson,
                    payment_method: paymentMethod,
                    estimated_delivery: deliveryDate ? deliveryDate + 'T00:00:00' : null
                }]
            };
            
            log(`ğŸ“‹ è¯¢ä»·æ•°æ®ç»“æ„: ${JSON.stringify(quoteData, null, 2)}`, 'debug');
            
            try {
                log('ğŸ“¡ å‘é€POSTè¯·æ±‚åˆ°è¯¢ä»·API...', 'info');
                
                const response = await fetch(`/api/v1/purchases/${requestId}/quote`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(quoteData)
                });
                
                log(`ğŸ“¡ è¯¢ä»·å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, 'debug');
                log(`ğŸ“¡ å“åº”å¤´: ${JSON.stringify([...response.headers.entries()])}`, 'debug');
                
                const responseText = await response.text();
                log(`ğŸ“‹ åŸå§‹å“åº”å†…å®¹: ${responseText}`, 'debug');
                
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                    log(`ğŸ“‹ è§£æåå“åº”æ•°æ®: ${JSON.stringify(responseData, null, 2)}`, 'debug');
                } catch (e) {
                    log(`âŒ JSONè§£æå¤±è´¥: ${e.message}`, 'error');
                    responseData = { message: responseText };
                }
                
                if (response.ok) {
                    document.getElementById('quoteResult').innerHTML = 
                        `<span class="success">âœ… è¯¢ä»·æˆåŠŸï¼çŠ¶æ€: ${responseData.status}</span>`;
                    log(`ğŸ‰ è¯¢ä»·æˆåŠŸ! ç”³è´­å•çŠ¶æ€: ${responseData.status}`, 'success');
                    log(`ğŸ’° æ€»é‡‘é¢: Â¥${responseData.total_amount}`, 'success');
                    log(`ğŸ‘¨â€ğŸ’¼ å½“å‰æ­¥éª¤: ${responseData.current_step}`, 'success');
                } else {
                    document.getElementById('quoteResult').innerHTML = 
                        `<span class="error">âŒ è¯¢ä»·å¤±è´¥: ${responseData.detail || responseData.message}</span>`;
                    log(`âŒ è¯¢ä»·å¤±è´¥ (${response.status}): ${responseData.detail || responseData.message}`, 'error');
                    
                    // è¯¦ç»†é”™è¯¯åˆ†æ
                    if (response.status === 422) {
                        log(`ğŸ” 422é”™è¯¯é€šå¸¸æ˜¯æ•°æ®éªŒè¯é—®é¢˜`, 'warning');
                        if (responseData.detail && Array.isArray(responseData.detail)) {
                            responseData.detail.forEach((err, idx) => {
                                log(`   éªŒè¯é”™è¯¯${idx + 1}: ${err.msg} (å­—æ®µ: ${err.loc?.join('.')})`, 'warning');
                            });
                        }
                    } else if (response.status === 400) {
                        log(`ğŸ” 400é”™è¯¯å¯èƒ½æ˜¯ä¸šåŠ¡é€»è¾‘é—®é¢˜`, 'warning');
                    } else if (response.status === 403) {
                        log(`ğŸ” 403é”™è¯¯æ˜¯æƒé™é—®é¢˜`, 'warning');
                    } else if (response.status === 500) {
                        log(`ğŸ” 500é”™è¯¯æ˜¯æœåŠ¡å™¨å†…éƒ¨é”™è¯¯`, 'warning');
                    }
                }
            } catch (error) {
                log(`ğŸ’¥ æäº¤å¼‚å¸¸: ${error.message}`, 'error');
                log(`ğŸ” å¼‚å¸¸å †æ ˆ: ${error.stack}`, 'error');
                log(`ğŸ” å¼‚å¸¸ç±»å‹: ${error.constructor.name}`, 'error');
                
                document.getElementById('quoteResult').innerHTML = 
                    `<span class="error">âŒ æäº¤å¼‚å¸¸: ${error.message}</span>`;
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            log('ğŸŒŸ Consoleè°ƒè¯•é¡µé¢åŠ è½½å®Œæˆ', 'success');
            log('ğŸ“ è¯·æŒ‰é¡ºåºæ‰§è¡Œ: 1.ç™»å½• -> 2.è·å–åˆ—è¡¨ -> 3.æäº¤è¯¢ä»·', 'info');
        };
        
        // æ•è·æ‰€æœ‰æœªå¤„ç†çš„é”™è¯¯
        window.addEventListener('error', function(e) {
            log(`ğŸ’¥ å…¨å±€é”™è¯¯: ${e.message}`, 'error');
            log(`ğŸ“ æ–‡ä»¶: ${e.filename}:${e.lineno}:${e.colno}`, 'error');
        });
        
        // æ•è·Promise rejection
        window.addEventListener('unhandledrejection', function(e) {
            log(`ğŸ’¥ æœªå¤„ç†çš„Promiseé”™è¯¯: ${e.reason}`, 'error');
        });
    </script>
</body>
</html>