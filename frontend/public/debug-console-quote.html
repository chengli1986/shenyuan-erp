<!DOCTYPE html>
<html>
<head>
    <title>Console调试 - 询价功能</title>
    <style>
        body { 
            font-family: Arial; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 6px;
            background: #fafafa;
        }
        input, textarea, select { 
            width: 100%; 
            max-width: 300px;
            margin: 5px 0; 
            padding: 8px; 
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button { 
            padding: 10px 20px; 
            margin: 10px 5px; 
            background: #1890ff; 
            color: white; 
            border: none; 
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.3s;
        }
        button:hover { background: #40a9ff; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .error { color: #ff4d4f; font-weight: bold; }
        .success { color: #52c41a; font-weight: bold; }
        .warning { color: #faad14; font-weight: bold; }
        .info { color: #1890ff; }
        .log { 
            background: #000; 
            color: #0f0; 
            padding: 15px; 
            margin: 10px 0; 
            white-space: pre-wrap; 
            font-family: 'Courier New', monospace;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        .step-title {
            background: #e6f7ff;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #1890ff;
            font-weight: bold;
        }
        .form-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 10px 0;
        }
        .form-row label {
            min-width: 100px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Console调试 - 询价功能</h1>
        <p>这个页面会提供详细的console日志来帮助调试前端询价提交问题</p>
        
        <div class="section">
            <div class="step-title">步骤1: 登录采购员账号</div>
            <button onclick="loginPurchaser()">登录采购员 (purchaser)</button>
            <div id="loginStatus"></div>
        </div>
        
        <div class="section">
            <div class="step-title">步骤2: 获取待询价申购单</div>
            <button onclick="getSubmittedRequests()">获取待询价列表</button>
            <div id="requestList"></div>
        </div>
        
        <div class="section">
            <div class="step-title">步骤3: 模拟前端表单提交</div>
            <div class="form-row">
                <label>申购单ID:</label>
                <input type="text" id="requestId" value="66">
                <button onclick="getRequestDetail()">获取详情</button>
            </div>
            <div id="requestDetail"></div>
            
            <h4>询价表单数据:</h4>
            <div class="form-row">
                <label>物料ID:</label>
                <input type="text" id="itemId" value="">
            </div>
            <div class="form-row">
                <label>单价:</label>
                <input type="number" id="unitPrice" value="1200">
            </div>
            <div class="form-row">
                <label>供应商:</label>
                <input type="text" id="supplierName" value="Console测试供应商">
            </div>
            <div class="form-row">
                <label>联系人:</label>
                <input type="text" id="contactPerson" value="张经理">
            </div>
            <div class="form-row">
                <label>联系方式:</label>
                <input type="text" id="contact" value="13900139000">
            </div>
            <div class="form-row">
                <label>付款方式:</label>
                <input type="text" id="paymentMethod" value="月结45天">
            </div>
            <div class="form-row">
                <label>预计到货:</label>
                <input type="date" id="deliveryDate" value="2025-09-20">
            </div>
            <div class="form-row">
                <label>询价备注:</label>
                <textarea id="notes" rows="3">Console调试测试询价</textarea>
            </div>
            
            <button onclick="submitQuoteWithConsole()" style="background: #52c41a;">📋 提交询价 (详细日志)</button>
            <button onclick="clearLogs()" style="background: #faad14;">🧹 清空日志</button>
            
            <div id="quoteResult"></div>
        </div>
        
        <div class="section">
            <div class="step-title">Console输出日志</div>
            <div id="consoleLog" class="log">等待操作...</div>
        </div>
    </div>
    
    <script>
        let token = '';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                error: '#ff4d4f',
                success: '#52c41a', 
                warning: '#faad14',
                info: '#0ff',
                debug: '#ff0'
            };
            const color = colors[type] || '#0f0';
            
            logDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // 同时输出到browser console
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLogs() {
            document.getElementById('consoleLog').innerHTML = '';
        }
        
        async function loginPurchaser() {
            try {
                log('🔐 开始登录采购员账号...', 'info');
                
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'username=purchaser&password=purchase123'
                });
                
                log(`📡 登录响应状态: ${response.status} ${response.statusText}`, 'debug');
                
                const data = await response.json();
                log(`📋 登录响应数据: ${JSON.stringify(data, null, 2)}`, 'debug');
                
                if (response.ok && data.access_token) {
                    token = data.access_token;
                    document.getElementById('loginStatus').innerHTML = 
                        `<span class="success">✅ 登录成功: ${data.user.name} (${data.user.role})</span>`;
                    log(`✅ Token获取成功: ${token.substring(0, 20)}...`, 'success');
                } else {
                    document.getElementById('loginStatus').innerHTML = 
                        `<span class="error">❌ 登录失败</span>`;
                    log(`❌ 登录失败: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                log(`💥 登录异常: ${error.message}`, 'error');
                log(`🔍 异常堆栈: ${error.stack}`, 'error');
                document.getElementById('loginStatus').innerHTML = 
                    `<span class="error">❌ 登录异常: ${error.message}</span>`;
            }
        }
        
        async function getSubmittedRequests() {
            if (!token) {
                alert('请先登录');
                return;
            }
            
            try {
                log('📋 获取待询价申购单列表...', 'info');
                
                const response = await fetch('/api/v1/purchases/?status=submitted', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                log(`📡 申购单列表响应: ${response.status} ${response.statusText}`, 'debug');
                
                const data = await response.json();
                log(`📋 申购单数据: ${JSON.stringify(data, null, 2)}`, 'debug');
                
                if (response.ok) {
                    const items = data.items || [];
                    let html = `<h4>待询价申购单 (${items.length}条)</h4><ul>`;
                    items.forEach(item => {
                        html += `<li><strong>${item.request_code}</strong> - ${item.project_name || 'N/A'} (ID: ${item.id})</li>`;
                    });
                    html += '</ul>';
                    document.getElementById('requestList').innerHTML = html;
                    
                    log(`✅ 找到 ${items.length} 个待询价申购单`, 'success');
                    
                    // 自动填充PR202508200001
                    const targetRequest = items.find(item => item.request_code === 'PR202508200001');
                    if (targetRequest) {
                        document.getElementById('requestId').value = targetRequest.id;
                        log(`🎯 自动选择目标申购单: ${targetRequest.request_code} (ID: ${targetRequest.id})`, 'success');
                    }
                } else {
                    log(`❌ 获取失败: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                log(`💥 获取异常: ${error.message}`, 'error');
                log(`🔍 异常堆栈: ${error.stack}`, 'error');
            }
        }
        
        async function getRequestDetail() {
            const requestId = document.getElementById('requestId').value;
            if (!token || !requestId) {
                alert('请先登录并填写申购单ID');
                return;
            }
            
            try {
                log(`📋 获取申购单 ${requestId} 详情...`, 'info');
                
                const response = await fetch(`/api/v1/purchases/${requestId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                log(`📡 详情响应: ${response.status} ${response.statusText}`, 'debug');
                
                const data = await response.json();
                log(`📋 详情数据: ${JSON.stringify(data, null, 2)}`, 'debug');
                
                if (response.ok && data.items && data.items.length > 0) {
                    const firstItem = data.items[0];
                    document.getElementById('itemId').value = firstItem.id;
                    
                    let html = `<h4>申购单详情</h4>`;
                    html += `<p><strong>编号:</strong> ${data.request_code}</p>`;
                    html += `<p><strong>状态:</strong> ${data.status}</p>`;
                    html += `<p><strong>明细项数量:</strong> ${data.items.length}</p>`;
                    html += `<p><strong>第一项:</strong> ${firstItem.item_name} (ID: ${firstItem.id})</p>`;
                    
                    document.getElementById('requestDetail').innerHTML = html;
                    log(`✅ 自动填充物料ID: ${firstItem.id} (${firstItem.item_name})`, 'success');
                } else {
                    log(`❌ 获取详情失败或无明细项`, 'error');
                }
            } catch (error) {
                log(`💥 获取详情异常: ${error.message}`, 'error');
                log(`🔍 异常堆栈: ${error.stack}`, 'error');
            }
        }
        
        async function submitQuoteWithConsole() {
            if (!token) {
                alert('请先登录');
                return;
            }
            
            const requestId = document.getElementById('requestId').value;
            const itemId = document.getElementById('itemId').value;
            const unitPrice = parseFloat(document.getElementById('unitPrice').value);
            const supplierName = document.getElementById('supplierName').value;
            const contactPerson = document.getElementById('contactPerson').value;
            const contact = document.getElementById('contact').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            const notes = document.getElementById('notes').value;
            
            log('🚀 开始提交询价...', 'info');
            log(`📋 申购单ID: ${requestId}`, 'debug');
            log(`📋 物料ID: ${itemId}`, 'debug');
            
            // 构建询价数据 - 模拟前端React表单的数据结构
            const quoteData = {
                quote_notes: notes,
                items: [{
                    item_id: parseInt(itemId),
                    unit_price: unitPrice,
                    supplier_name: supplierName,
                    supplier_contact: contact,
                    supplier_contact_person: contactPerson,
                    payment_method: paymentMethod,
                    estimated_delivery: deliveryDate ? deliveryDate + 'T00:00:00' : null
                }]
            };
            
            log(`📋 询价数据结构: ${JSON.stringify(quoteData, null, 2)}`, 'debug');
            
            try {
                log('📡 发送POST请求到询价API...', 'info');
                
                const response = await fetch(`/api/v1/purchases/${requestId}/quote`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(quoteData)
                });
                
                log(`📡 询价响应状态: ${response.status} ${response.statusText}`, 'debug');
                log(`📡 响应头: ${JSON.stringify([...response.headers.entries()])}`, 'debug');
                
                const responseText = await response.text();
                log(`📋 原始响应内容: ${responseText}`, 'debug');
                
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                    log(`📋 解析后响应数据: ${JSON.stringify(responseData, null, 2)}`, 'debug');
                } catch (e) {
                    log(`❌ JSON解析失败: ${e.message}`, 'error');
                    responseData = { message: responseText };
                }
                
                if (response.ok) {
                    document.getElementById('quoteResult').innerHTML = 
                        `<span class="success">✅ 询价成功！状态: ${responseData.status}</span>`;
                    log(`🎉 询价成功! 申购单状态: ${responseData.status}`, 'success');
                    log(`💰 总金额: ¥${responseData.total_amount}`, 'success');
                    log(`👨‍💼 当前步骤: ${responseData.current_step}`, 'success');
                } else {
                    document.getElementById('quoteResult').innerHTML = 
                        `<span class="error">❌ 询价失败: ${responseData.detail || responseData.message}</span>`;
                    log(`❌ 询价失败 (${response.status}): ${responseData.detail || responseData.message}`, 'error');
                    
                    // 详细错误分析
                    if (response.status === 422) {
                        log(`🔍 422错误通常是数据验证问题`, 'warning');
                        if (responseData.detail && Array.isArray(responseData.detail)) {
                            responseData.detail.forEach((err, idx) => {
                                log(`   验证错误${idx + 1}: ${err.msg} (字段: ${err.loc?.join('.')})`, 'warning');
                            });
                        }
                    } else if (response.status === 400) {
                        log(`🔍 400错误可能是业务逻辑问题`, 'warning');
                    } else if (response.status === 403) {
                        log(`🔍 403错误是权限问题`, 'warning');
                    } else if (response.status === 500) {
                        log(`🔍 500错误是服务器内部错误`, 'warning');
                    }
                }
            } catch (error) {
                log(`💥 提交异常: ${error.message}`, 'error');
                log(`🔍 异常堆栈: ${error.stack}`, 'error');
                log(`🔍 异常类型: ${error.constructor.name}`, 'error');
                
                document.getElementById('quoteResult').innerHTML = 
                    `<span class="error">❌ 提交异常: ${error.message}</span>`;
            }
        }
        
        // 页面加载完成
        window.onload = function() {
            log('🌟 Console调试页面加载完成', 'success');
            log('📝 请按顺序执行: 1.登录 -> 2.获取列表 -> 3.提交询价', 'info');
        };
        
        // 捕获所有未处理的错误
        window.addEventListener('error', function(e) {
            log(`💥 全局错误: ${e.message}`, 'error');
            log(`📍 文件: ${e.filename}:${e.lineno}:${e.colno}`, 'error');
        });
        
        // 捕获Promise rejection
        window.addEventListener('unhandledrejection', function(e) {
            log(`💥 未处理的Promise错误: ${e.reason}`, 'error');
        });
    </script>
</body>
</html>