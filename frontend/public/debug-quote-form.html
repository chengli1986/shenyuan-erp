<!DOCTYPE html>
<html>
<head>
    <title>è¯¢ä»·åŠŸèƒ½è°ƒè¯•</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .section { margin: 20px 0; padding: 10px; border: 1px solid #ddd; }
        input, textarea { width: 300px; margin: 5px 0; padding: 5px; }
        button { padding: 10px 20px; margin: 10px 0; background: #1890ff; color: white; border: none; cursor: pointer; }
        button:hover { background: #40a9ff; }
        .error { color: red; }
        .success { color: green; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ” è¯¢ä»·åŠŸèƒ½è°ƒè¯•é¡µé¢</h1>
    
    <div class="section">
        <h2>1. ç™»å½•æµ‹è¯•</h2>
        <button onclick="login()">ç™»å½•é‡‡è´­å‘˜è´¦å·</button>
        <div id="loginResult"></div>
    </div>
    
    <div class="section">
        <h2>2. è·å–å¾…è¯¢ä»·ç”³è´­å•</h2>
        <button onclick="getSubmittedRequests()">è·å–å¾…è¯¢ä»·åˆ—è¡¨</button>
        <div id="requestList"></div>
    </div>
    
    <div class="section">
        <h2>3. æ¨¡æ‹Ÿè¯¢ä»·æäº¤</h2>
        <div>
            ç”³è´­å•ID: <input type="text" id="requestId" value="51"><br>
            ç‰©æ–™ID: <input type="text" id="itemId" value="59"><br>
            å•ä»·: <input type="number" id="unitPrice" value="1000"><br>
            ä¾›åº”å•†: <input type="text" id="supplierName" value="æµ‹è¯•ä¾›åº”å•†"><br>
            è”ç³»äºº: <input type="text" id="contactPerson" value="å¼ ç»ç†"><br>
            è”ç³»æ–¹å¼: <input type="text" id="contact" value="13800138000"><br>
            ä»˜æ¬¾æ–¹å¼: <input type="text" id="paymentMethod" value="æœˆç»“30å¤©"><br>
            é¢„è®¡åˆ°è´§: <input type="date" id="deliveryDate" value="2025-09-01"><br>
            å¤‡æ³¨: <textarea id="notes">æµ‹è¯•è¯¢ä»·</textarea><br>
            <button onclick="submitQuote()">æäº¤è¯¢ä»·</button>
        </div>
        <div id="quoteResult"></div>
    </div>
    
    <div class="section">
        <h2>è°ƒè¯•æ—¥å¿—</h2>
        <div id="debugLog" class="log"></div>
    </div>
    
    <script>
        let token = '';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            console.log(message);
        }
        
        async function login() {
            try {
                log('å¼€å§‹ç™»å½•...');
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'username=purchaser&password=purchase123'
                });
                
                const data = await response.json();
                log('ç™»å½•å“åº”: ' + JSON.stringify(data, null, 2));
                
                if (response.ok && data.access_token) {
                    token = data.access_token;
                    document.getElementById('loginResult').innerHTML = 
                        `<span class="success">âœ… ç™»å½•æˆåŠŸ: ${data.user.name}</span>`;
                    log('Tokenè·å–æˆåŠŸ', 'success');
                } else {
                    document.getElementById('loginResult').innerHTML = 
                        `<span class="error">âŒ ç™»å½•å¤±è´¥</span>`;
                    log('ç™»å½•å¤±è´¥: ' + JSON.stringify(data), 'error');
                }
            } catch (error) {
                log('ç™»å½•å¼‚å¸¸: ' + error.message, 'error');
                document.getElementById('loginResult').innerHTML = 
                    `<span class="error">âŒ ç™»å½•å¼‚å¸¸: ${error.message}</span>`;
            }
        }
        
        async function getSubmittedRequests() {
            if (!token) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            try {
                log('è·å–å¾…è¯¢ä»·ç”³è´­å•...');
                const response = await fetch('/api/v1/purchases/?status=submitted', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                log('ç”³è´­å•åˆ—è¡¨: ' + JSON.stringify(data, null, 2));
                
                if (response.ok) {
                    const items = data.items || [];
                    let html = `<h3>å¾…è¯¢ä»·ç”³è´­å• (${items.length}æ¡)</h3><ul>`;
                    items.forEach(item => {
                        html += `<li>ID: ${item.id}, ç¼–å·: ${item.request_code}, é¡¹ç›®: ${item.project_name}</li>`;
                    });
                    html += '</ul>';
                    document.getElementById('requestList').innerHTML = html;
                    
                    // è‡ªåŠ¨å¡«å……ç¬¬ä¸€ä¸ªç”³è´­å•ID
                    if (items.length > 0) {
                        document.getElementById('requestId').value = items[0].id;
                        // è·å–ç”³è´­å•è¯¦æƒ…
                        getRequestDetails(items[0].id);
                    }
                } else {
                    log('è·å–å¤±è´¥: ' + JSON.stringify(data), 'error');
                }
            } catch (error) {
                log('è·å–å¼‚å¸¸: ' + error.message, 'error');
            }
        }
        
        async function getRequestDetails(requestId) {
            try {
                log(`è·å–ç”³è´­å• ${requestId} è¯¦æƒ…...`);
                const response = await fetch(`/api/v1/purchases/${requestId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                log('ç”³è´­å•è¯¦æƒ…: ' + JSON.stringify(data, null, 2));
                
                if (response.ok && data.items && data.items.length > 0) {
                    // è‡ªåŠ¨å¡«å……ç¬¬ä¸€ä¸ªç‰©æ–™ID
                    document.getElementById('itemId').value = data.items[0].id;
                    log(`è‡ªåŠ¨å¡«å……ç‰©æ–™ID: ${data.items[0].id}`, 'success');
                }
            } catch (error) {
                log('è·å–è¯¦æƒ…å¼‚å¸¸: ' + error.message, 'error');
            }
        }
        
        async function submitQuote() {
            if (!token) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            const requestId = document.getElementById('requestId').value;
            const itemId = document.getElementById('itemId').value;
            const unitPrice = parseFloat(document.getElementById('unitPrice').value);
            const supplierName = document.getElementById('supplierName').value;
            const contactPerson = document.getElementById('contactPerson').value;
            const contact = document.getElementById('contact').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            const notes = document.getElementById('notes').value;
            
            const quoteData = {
                quote_notes: notes,
                items: [{
                    item_id: parseInt(itemId),
                    unit_price: unitPrice,
                    supplier_name: supplierName,
                    supplier_contact: contact,
                    supplier_contact_person: contactPerson,
                    payment_method: paymentMethod,
                    estimated_delivery: deliveryDate + 'T00:00:00'
                }]
            };
            
            try {
                log('æäº¤è¯¢ä»·æ•°æ®: ' + JSON.stringify(quoteData, null, 2));
                
                const response = await fetch(`/api/v1/purchases/${requestId}/quote`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(quoteData)
                });
                
                const responseText = await response.text();
                log('å“åº”çŠ¶æ€: ' + response.status);
                log('å“åº”å†…å®¹: ' + responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    data = { message: responseText };
                }
                
                if (response.ok) {
                    document.getElementById('quoteResult').innerHTML = 
                        `<span class="success">âœ… è¯¢ä»·æˆåŠŸï¼</span>`;
                    log('è¯¢ä»·æˆåŠŸ: ' + JSON.stringify(data), 'success');
                } else {
                    document.getElementById('quoteResult').innerHTML = 
                        `<span class="error">âŒ è¯¢ä»·å¤±è´¥: ${data.detail || data.message}</span>`;
                    log('è¯¢ä»·å¤±è´¥: ' + JSON.stringify(data), 'error');
                }
            } catch (error) {
                log('æäº¤å¼‚å¸¸: ' + error.message, 'error');
                document.getElementById('quoteResult').innerHTML = 
                    `<span class="error">âŒ æäº¤å¼‚å¸¸: ${error.message}</span>`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨ç™»å½•
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•...');
        };
    </script>
</body>
</html>