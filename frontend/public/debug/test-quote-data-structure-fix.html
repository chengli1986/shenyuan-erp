<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¢ä»·æ•°æ®ç»“æ„ä¿®å¤éªŒè¯</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .problem-section { background-color: #fff2e8; }
        .solution-section { background-color: #e8f5e8; }
        .test-section { background-color: #f0f8ff; }
        button { margin: 5px; padding: 8px 15px; cursor: pointer; }
        .result { margin-top: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 3px; white-space: pre-wrap; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .highlight { background-color: #ffeb3b; font-weight: bold; }
    </style>
</head>
<body>
    <h1>è¯¢ä»·æ•°æ®ç»“æ„æ˜¾ç¤ºä¿®å¤éªŒè¯</h1>
    
    <div class="section problem-section">
        <h3>ğŸ› é—®é¢˜æè¿°</h3>
        <p>ç”¨æˆ·åé¦ˆï¼šé‡‡è´­å‘˜å’Œéƒ¨é—¨ä¸»ç®¡æŸ¥çœ‹æœªå®Œå…¨æ‰¹å¤çš„ç”³è´­å•æ—¶ï¼Œä»˜æ¬¾æ–¹å¼å’Œé¢„è®¡äº¤è´§æ˜¾ç¤ºæ¨ªæ ï¼Œä½†å®Œå…¨æ‰¹å¤çš„ç”³è´­å•å¯ä»¥çœ‹åˆ°è¿™äº›ä¿¡æ¯ã€‚</p>
        
        <h4>é—®é¢˜åˆ†æï¼š</h4>
        <ul>
            <li><strong>æ•°æ®å­˜å‚¨ä½ç½®ä¸ä¸€è‡´</strong>ï¼šè¯¢ä»·æ•°æ®å­˜å‚¨åœ¨ä¸åŒå­—æ®µä¸­</li>
            <li><strong>å‰ç«¯è¯»å–é€»è¾‘é”™è¯¯</strong>ï¼šæ²¡æœ‰æŒ‰æ­£ç¡®ä¼˜å…ˆçº§è¯»å–æ•°æ®</li>
            <li><strong>çŠ¶æ€ç›¸å…³çš„é€»è¾‘å†²çª</strong>ï¼šä¸åŒçŠ¶æ€ä¸‹æ•°æ®ç»“æ„ä¸åŒ</li>
        </ul>
        
        <button onclick="analyzeProblem()">åˆ†æé—®é¢˜</button>
        <div id="problem-result" class="result" style="display:none;"></div>
    </div>

    <div class="section solution-section">
        <h3>âœ… ä¿®å¤æ–¹æ¡ˆ</h3>
        <p>ä¿®å¤å‰ç«¯æ•°æ®è¯»å–é€»è¾‘ï¼ŒæŒ‰æ­£ç¡®ä¼˜å…ˆçº§è¯»å–è¯¢ä»·ä¿¡æ¯ï¼š</p>
        
        <h4>ä»˜æ¬¾æ–¹å¼è¯»å–ä¼˜å…ˆçº§ï¼š</h4>
        <ol>
            <li><code>item.payment_method</code> (ç›´æ¥å­—æ®µ)</li>
            <li><code>item.supplier_info.payment_method</code> (å®é™…å­˜å‚¨ä½ç½®)</li>
            <li><code>purchaseData.payment_method</code> (ç”³è´­å•çº§åˆ«)</li>
        </ol>
        
        <h4>é¢„è®¡äº¤è´§è¯»å–ä¼˜å…ˆçº§ï¼š</h4>
        <ol>
            <li><code>item.estimated_delivery_date</code> (ç›´æ¥å­—æ®µ)</li>
            <li><code>item.estimated_delivery</code> (å®é™…å­˜å‚¨ä½ç½®)</li>
            <li><code>purchaseData.estimated_delivery_date</code> (ç”³è´­å•çº§åˆ«)</li>
        </ol>
        
        <button onclick="simulateFixedLogic()">æ¨¡æ‹Ÿä¿®å¤åé€»è¾‘</button>
        <div id="solution-result" class="result" style="display:none;"></div>
    </div>

    <div class="section test-section">
        <h3>ğŸ§ª å®é™…æ•°æ®éªŒè¯</h3>
        <p>éªŒè¯ä¸åŒçŠ¶æ€ç”³è´­å•çš„æ•°æ®ç»“æ„å’Œæ˜¾ç¤ºæ•ˆæœ</p>
        
        <div>
            <h4>æµ‹è¯•ç”³è´­å•ï¼š</h4>
            <button onclick="testPurchase(64)">ç”³è´­å•64 (final_approved)</button>
            <button onclick="testPurchase(65)">ç”³è´­å•65 (dept_approved)</button>
            <button onclick="testPurchase(67)">ç”³è´­å•67 (final_approved)</button>
        </div>
        
        <div>
            <h4>ä¸åŒè§’è‰²æµ‹è¯•ï¼š</h4>
            <button onclick="testAllRoles()">æµ‹è¯•æ‰€æœ‰è§’è‰²è§†å›¾</button>
            <button onclick="compareDataStructures()">å¯¹æ¯”æ•°æ®ç»“æ„</button>
        </div>
        
        <div id="test-result" class="result" style="display:none;"></div>
    </div>

    <div class="section">
        <h3>ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”</h3>
        <p>å±•ç¤ºä¿®å¤å‰åçš„æ•°æ®æ˜¾ç¤ºæ•ˆæœå¯¹æ¯”</p>
        
        <button onclick="showBeforeAfterComparison()">æ˜¾ç¤ºä¿®å¤å¯¹æ¯”</button>
        <div id="comparison-result" class="result" style="display:none;"></div>
    </div>

    <script>
        // åˆ†æé—®é¢˜
        async function analyzeProblem() {
            const resultDiv = document.getElementById('problem-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨åˆ†æé—®é¢˜...';

            try {
                const loginResponse = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'username=admin&password=admin123'
                });
                const loginData = await loginResponse.json();

                // è·å–ä¸åŒçŠ¶æ€çš„ç”³è´­å•
                const listResponse = await fetch('/api/v1/purchases/', {
                    headers: { 'Authorization': `Bearer ${loginData.access_token}` }
                });
                const listData = await listResponse.json();

                const analysis = {
                    ä¸åŒçŠ¶æ€ç”³è´­å•ç»Ÿè®¡: {},
                    æ•°æ®å­˜å‚¨é—®é¢˜: {
                        éƒ¨é—¨å®¡æ‰¹çŠ¶æ€: {},
                        æœ€ç»ˆå®¡æ‰¹çŠ¶æ€: {}
                    }
                };

                // ç»Ÿè®¡ä¸åŒçŠ¶æ€
                listData.items.forEach(item => {
                    const status = item.status;
                    if (!analysis.ä¸åŒçŠ¶æ€ç”³è´­å•ç»Ÿè®¡[status]) {
                        analysis.ä¸åŒçŠ¶æ€ç”³è´­å•ç»Ÿè®¡[status] = 0;
                    }
                    analysis.ä¸åŒçŠ¶æ€ç”³è´­å•ç»Ÿè®¡[status]++;
                });

                // æ£€æŸ¥å…·ä½“æ•°æ®ç»“æ„
                const deptApproved = listData.items.find(item => item.status === 'dept_approved');
                const finalApproved = listData.items.find(item => item.status === 'final_approved');

                if (deptApproved) {
                    analysis.æ•°æ®å­˜å‚¨é—®é¢˜.éƒ¨é—¨å®¡æ‰¹çŠ¶æ€ = {
                        ç”³è´­å•å·: deptApproved.request_code,
                        ç”³è´­å•çº§ä»˜æ¬¾æ–¹å¼: deptApproved.payment_method,
                        ç”³è´­å•çº§é¢„è®¡äº¤è´§: deptApproved.estimated_delivery_date
                    };
                }

                if (finalApproved) {
                    analysis.æ•°æ®å­˜å‚¨é—®é¢˜.æœ€ç»ˆå®¡æ‰¹çŠ¶æ€ = {
                        ç”³è´­å•å·: finalApproved.request_code,
                        ç”³è´­å•çº§ä»˜æ¬¾æ–¹å¼: finalApproved.payment_method,
                        ç”³è´­å•çº§é¢„è®¡äº¤è´§: finalApproved.estimated_delivery_date
                    };
                }

                resultDiv.className = 'result warning';
                resultDiv.textContent = JSON.stringify(analysis, null, 2);

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `é”™è¯¯: ${error.message}`;
            }
        }

        // æ¨¡æ‹Ÿä¿®å¤åé€»è¾‘
        function simulateFixedLogic() {
            const resultDiv = document.getElementById('solution-result');
            resultDiv.style.display = 'block';

            // æ¨¡æ‹Ÿä¸åŒçš„æ•°æ®ç»“æ„æƒ…å†µ
            const scenarios = [
                {
                    åœºæ™¯: "éƒ¨é—¨å®¡æ‰¹çŠ¶æ€ (dept_approved)",
                    purchaseData: { payment_method: null, estimated_delivery_date: null },
                    itemData: { 
                        payment_method: null,
                        estimated_delivery_date: null,
                        supplier_info: { payment_method: "PREPAYMENT" },
                        estimated_delivery: "2025-08-21T00:00:00"
                    }
                },
                {
                    åœºæ™¯: "æœ€ç»ˆå®¡æ‰¹çŠ¶æ€ (final_approved)",
                    purchaseData: { payment_method: "PREPAYMENT", estimated_delivery_date: "2025-08-25T10:00:00" },
                    itemData: { 
                        payment_method: null,
                        estimated_delivery_date: null,
                        supplier_info: null,
                        estimated_delivery: null
                    }
                }
            ];

            const paymentMethods = {
                'PREPAYMENT': 'é¢„ä»˜æ¬¾',
                'ON_DELIVERY': 'è´§åˆ°ä»˜æ¬¾',
                'MONTHLY': 'æœˆç»“',
                'INSTALLMENT': 'åˆ†æœŸä»˜æ¬¾'
            };

            const results = scenarios.map(scenario => {
                const { purchaseData, itemData } = scenario;
                
                // ä¿®å¤å‰é€»è¾‘
                const oldPayment = itemData.payment_method || purchaseData.payment_method;
                const oldDelivery = itemData.estimated_delivery_date || purchaseData.estimated_delivery_date;
                
                // ä¿®å¤åé€»è¾‘  
                const newPayment = itemData.payment_method || 
                                  itemData.supplier_info?.payment_method || 
                                  purchaseData.payment_method;
                const newDelivery = itemData.estimated_delivery_date || 
                                   itemData.estimated_delivery || 
                                   purchaseData.estimated_delivery_date;

                return {
                    åœºæ™¯: scenario.åœºæ™¯,
                    ä¿®å¤å‰æ˜¾ç¤º: {
                        ä»˜æ¬¾æ–¹å¼: paymentMethods[oldPayment] || oldPayment || 'æ¨ªæ ',
                        é¢„è®¡äº¤è´§: oldDelivery ? new Date(oldDelivery).toLocaleDateString('zh-CN') : 'æ¨ªæ '
                    },
                    ä¿®å¤åæ˜¾ç¤º: {
                        ä»˜æ¬¾æ–¹å¼: paymentMethods[newPayment] || newPayment || 'æ¨ªæ ',
                        é¢„è®¡äº¤è´§: newDelivery ? new Date(newDelivery).toLocaleDateString('zh-CN') : 'æ¨ªæ '
                    },
                    æ˜¯å¦ä¿®å¤: {
                        ä»˜æ¬¾æ–¹å¼: (oldPayment || 'æ¨ªæ ') !== (newPayment || 'æ¨ªæ ') ? 'æ˜¯' : 'å¦',
                        é¢„è®¡äº¤è´§: (oldDelivery || 'æ¨ªæ ') !== (newDelivery || 'æ¨ªæ ') ? 'æ˜¯' : 'å¦'
                    }
                };
            });

            resultDiv.className = 'result success';
            resultDiv.textContent = JSON.stringify(results, null, 2);
        }

        // æµ‹è¯•ç‰¹å®šç”³è´­å•
        async function testPurchase(purchaseId) {
            const resultDiv = document.getElementById('test-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = `æ­£åœ¨æµ‹è¯•ç”³è´­å• ${purchaseId}...`;

            try {
                const loginResponse = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'username=admin&password=admin123'
                });
                const loginData = await loginResponse.json();

                const detailResponse = await fetch(`/api/v1/purchases/${purchaseId}`, {
                    headers: { 'Authorization': `Bearer ${loginData.access_token}` }
                });
                const detailData = await detailResponse.json();

                const analysis = {
                    ç”³è´­å•ä¿¡æ¯: {
                        ç¼–å·: detailData.request_code,
                        çŠ¶æ€: detailData.status,
                        ç”³è´­å•çº§ä»˜æ¬¾æ–¹å¼: detailData.payment_method,
                        ç”³è´­å•çº§é¢„è®¡äº¤è´§: detailData.estimated_delivery_date
                    },
                    ç‰©æ–™é¡¹åˆ†æ: detailData.items.slice(0, 2).map(item => ({
                        ç‰©æ–™åç§°: item.item_name,
                        ä¾›åº”å•†: item.supplier_name,
                        æ•°æ®ç»“æ„: {
                            payment_method: item.payment_method,
                            estimated_delivery_date: item.estimated_delivery_date,
                            supplier_info: item.supplier_info,
                            estimated_delivery: item.estimated_delivery
                        },
                        ä¿®å¤åæ˜¾ç¤ºæ•ˆæœ: {
                            ä»˜æ¬¾æ–¹å¼: item.payment_method || item.supplier_info?.payment_method || detailData.payment_method || 'æ¨ªæ ',
                            é¢„è®¡äº¤è´§: item.estimated_delivery_date || item.estimated_delivery || detailData.estimated_delivery_date || 'æ¨ªæ '
                        }
                    }))
                };

                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(analysis, null, 2);

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `é”™è¯¯: ${error.message}`;
            }
        }

        // æµ‹è¯•æ‰€æœ‰è§’è‰²
        async function testAllRoles() {
            const resultDiv = document.getElementById('test-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•æ‰€æœ‰è§’è‰²...';

            try {
                const roles = [
                    { username: 'purchaser', password: 'purchase123', name: 'é‡‡è´­å‘˜' },
                    { username: 'dept_manager', password: 'dept123', name: 'éƒ¨é—¨ä¸»ç®¡' },
                    { username: 'sunyun', password: 'sunyun123', name: 'é¡¹ç›®ç»ç†' }
                ];

                const results = {};

                for (const role of roles) {
                    const loginResponse = await fetch('/api/v1/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `username=${role.username}&password=${role.password}`
                    });
                    const loginData = await loginResponse.json();

                    const listResponse = await fetch('/api/v1/purchases/', {
                        headers: { 'Authorization': `Bearer ${loginData.access_token}` }
                    });
                    const listData = await listResponse.json();

                    // æŸ¥æ‰¾æœ‰è¯¢ä»·ä¿¡æ¯çš„ç”³è´­å•
                    const quotedPurchases = listData.items.filter(item => 
                        ['price_quoted', 'dept_approved', 'final_approved'].includes(item.status)
                    );

                    results[role.name] = {
                        å¯æŸ¥çœ‹ç”³è´­å•æ•°: listData.total,
                        å·²è¯¢ä»·ç”³è´­å•æ•°: quotedPurchases.length,
                        æƒé™: {
                            å¯æŸ¥çœ‹ä»·æ ¼ä¿¡æ¯: role.username !== 'sunyun',
                            å¯æŸ¥çœ‹è¯¢ä»·ä¿¡æ¯: role.username !== 'sunyun'
                        },
                        ç¤ºä¾‹ç”³è´­å•: quotedPurchases.slice(0, 2).map(item => ({
                            ç¼–å·: item.request_code,
                            çŠ¶æ€: item.status,
                            ç”³è´­å•çº§ä»˜æ¬¾æ–¹å¼: item.payment_method || 'æ— ',
                            ç”³è´­å•çº§é¢„è®¡äº¤è´§: item.estimated_delivery_date || 'æ— '
                        }))
                    };
                }

                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(results, null, 2);

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `é”™è¯¯: ${error.message}`;
            }
        }

        // å¯¹æ¯”æ•°æ®ç»“æ„
        async function compareDataStructures() {
            const resultDiv = document.getElementById('test-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨å¯¹æ¯”æ•°æ®ç»“æ„...';

            try {
                const loginResponse = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'username=admin&password=admin123'
                });
                const loginData = await loginResponse.json();

                // è·å–ä¸åŒçŠ¶æ€çš„ç”³è´­å•è¯¦æƒ…
                const purchaseIds = [64, 65, 67]; // ä¸åŒçŠ¶æ€çš„ç”³è´­å•
                const comparisons = [];

                for (const id of purchaseIds) {
                    const detailResponse = await fetch(`/api/v1/purchases/${id}`, {
                        headers: { 'Authorization': `Bearer ${loginData.access_token}` }
                    });
                    const data = await detailResponse.json();
                    
                    const firstItem = data.items[0];
                    comparisons.push({
                        ç”³è´­å•: data.request_code,
                        çŠ¶æ€: data.status,
                        ç”³è´­å•çº§æ•°æ®: {
                            payment_method: data.payment_method,
                            estimated_delivery_date: data.estimated_delivery_date
                        },
                        ç‰©æ–™çº§æ•°æ®: firstItem ? {
                            payment_method: firstItem.payment_method,
                            estimated_delivery_date: firstItem.estimated_delivery_date,
                            supplier_info: firstItem.supplier_info,
                            estimated_delivery: firstItem.estimated_delivery
                        } : null,
                        ä¿®å¤åæ˜¾ç¤º: firstItem ? {
                            ä»˜æ¬¾æ–¹å¼: firstItem.payment_method || firstItem.supplier_info?.payment_method || data.payment_method || 'æ¨ªæ ',
                            é¢„è®¡äº¤è´§: firstItem.estimated_delivery_date || firstItem.estimated_delivery || data.estimated_delivery_date || 'æ¨ªæ '
                        } : null
                    });
                }

                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <h4>æ•°æ®ç»“æ„å¯¹æ¯”ï¼š</h4>
                    <table>
                        <tr>
                            <th>ç”³è´­å•</th><th>çŠ¶æ€</th><th>ä¿®å¤åä»˜æ¬¾æ–¹å¼</th><th>ä¿®å¤åé¢„è®¡äº¤è´§</th>
                        </tr>
                        ${comparisons.map(item => `
                            <tr>
                                <td>${item.ç”³è´­å•}</td>
                                <td>${item.çŠ¶æ€}</td>
                                <td class="${item.ä¿®å¤åæ˜¾ç¤º?.ä»˜æ¬¾æ–¹å¼ !== 'æ¨ªæ ' ? 'highlight' : ''}">${item.ä¿®å¤åæ˜¾ç¤º?.ä»˜æ¬¾æ–¹å¼ || 'æ— '}</td>
                                <td class="${item.ä¿®å¤åæ˜¾ç¤º?.é¢„è®¡äº¤è´§ !== 'æ¨ªæ ' ? 'highlight' : ''}">${item.ä¿®å¤åæ˜¾ç¤º?.é¢„è®¡äº¤è´§ || 'æ— '}</td>
                            </tr>
                        `).join('')}
                    </table>
                    <pre>${JSON.stringify(comparisons, null, 2)}</pre>
                `;

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `é”™è¯¯: ${error.message}`;
            }
        }

        // æ˜¾ç¤ºä¿®å¤å‰åå¯¹æ¯”
        function showBeforeAfterComparison() {
            const resultDiv = document.getElementById('comparison-result');
            resultDiv.style.display = 'block';

            const comparison = {
                ä¿®å¤å‰é—®é¢˜: {
                    éƒ¨é—¨å®¡æ‰¹çŠ¶æ€: "ä»˜æ¬¾æ–¹å¼å’Œé¢„è®¡äº¤è´§æ˜¾ç¤ºæ¨ªæ ",
                    æœ€ç»ˆå®¡æ‰¹çŠ¶æ€: "èƒ½æ­£ç¡®æ˜¾ç¤ºä»˜æ¬¾æ–¹å¼å’Œé¢„è®¡äº¤è´§",
                    é€»è¾‘å†²çª: "åŒæ ·æœ‰è¯¢ä»·ä¿¡æ¯ï¼Œä½†æ˜¾ç¤ºä¸ä¸€è‡´"
                },
                é—®é¢˜æ ¹å› : {
                    æ•°æ®å­˜å‚¨: "è¯¢ä»·ä¿¡æ¯å­˜å‚¨åœ¨ supplier_info.payment_method å’Œ estimated_delivery å­—æ®µä¸­",
                    å‰ç«¯é€»è¾‘: "åªè¯»å– payment_method å’Œ estimated_delivery_date å­—æ®µ",
                    æ•°æ®ç¼ºå¤±: "éƒ¨åˆ†ç”³è´­å•çš„ç”³è´­å•çº§åˆ«å­—æ®µä¸ºnullï¼Œç‰©æ–™çº§åˆ«æœ‰æ•°æ®"
                },
                ä¿®å¤æ–¹æ¡ˆ: {
                    è¯»å–ä¼˜å…ˆçº§: "ç‰©æ–™çº§ç›´æ¥å­—æ®µ â†’ å®é™…å­˜å‚¨å­—æ®µ â†’ ç”³è´­å•çº§å­—æ®µ",
                    ä»˜æ¬¾æ–¹å¼: "payment_method â†’ supplier_info.payment_method â†’ purchaseData.payment_method",
                    é¢„è®¡äº¤è´§: "estimated_delivery_date â†’ estimated_delivery â†’ purchaseData.estimated_delivery_date"
                },
                ä¿®å¤åæ•ˆæœ: {
                    ä¸€è‡´æ€§: "æ‰€æœ‰çŠ¶æ€çš„ç”³è´­å•éƒ½èƒ½æ­£ç¡®æ˜¾ç¤ºè¯¢ä»·ä¿¡æ¯",
                    æƒé™æ§åˆ¶: "é¡¹ç›®ç»ç†ä»ç„¶æ— æ³•çœ‹åˆ°è¯¢ä»·ä¿¡æ¯",
                    æ•°æ®å®Œæ•´: "å……åˆ†åˆ©ç”¨æ‰€æœ‰å¯èƒ½çš„æ•°æ®æº"
                }
            };

            resultDiv.className = 'result success';
            resultDiv.textContent = JSON.stringify(comparison, null, 2);
        }
    </script>
</body>
</html>