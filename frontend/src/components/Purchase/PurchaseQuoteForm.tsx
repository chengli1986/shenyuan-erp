import React, { useState, useEffect } from 'react';
import {
  Modal,
  Form,
  Input,
  InputNumber,
  DatePicker,
  Button,
  Table,
  message,
  Divider,
  Space,
  Typography,
  Card,
  Row,
  Col
} from 'antd';
import { DollarOutlined } from '@ant-design/icons';
import api from '../../services/api';
import dayjs from 'dayjs';

const { TextArea } = Input;
const { Title, Text } = Typography;

interface PurchaseItem {
  id: number;
  item_name: string;
  specification: string;
  brand: string;
  unit: string;
  quantity: number;
  unit_price?: number;
  total_price?: number;
  supplier_name?: string;
  supplier_contact?: string;
  supplier_contact_person?: string;  // Êñ∞Â¢ûÔºö‰æõÂ∫îÂïÜËÅîÁ≥ª‰∫∫ÂÖ®Âêç
  payment_method?: string;  // Êñ∞Â¢ûÔºöÁâ©ÊñôÁ∫ß‰ªòÊ¨æÊñπÂºè
  estimated_delivery?: string;
}

interface PurchaseQuoteFormProps {
  visible: boolean;
  purchaseData: any;
  onClose: () => void;
  onSuccess: () => void;
}

interface QuoteFormData {
  quote_notes?: string;
  items: Array<{
    item_id: number;
    unit_price: number;
    supplier_name: string;
    supplier_contact?: string;
    supplier_contact_person?: string;  // Êñ∞Â¢û
    payment_method?: string;  // Êñ∞Â¢û
    estimated_delivery?: string;
  }>;
}

const PurchaseQuoteForm: React.FC<PurchaseQuoteFormProps> = ({
  visible,
  purchaseData,
  onClose,
  onSuccess
}) => {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [items, setItems] = useState<PurchaseItem[]>([]);

  useEffect(() => {
    if (visible && purchaseData?.items) {
      setItems(purchaseData.items);
      // ÈáçÁΩÆË°®Âçï
      form.resetFields();
    }
  }, [visible, purchaseData, form]);

  const handleSubmit = async () => {
    try {
      setLoading(true);
      console.log('üìù [React] ÂºÄÂßãË°®ÂçïÈ™åËØÅ...');
      const values = await form.validateFields();
      console.log('‚úÖ [React] Ë°®ÂçïÈ™åËØÅÈÄöËøáÔºåËé∑ÂèñÂà∞ÁöÑvalues:', values);
      
      // ÊûÑÂª∫ËØ¢‰ª∑Êï∞ÊçÆ
      const quoteData: QuoteFormData = {
        quote_notes: values.quote_notes,
        items: items.map(item => ({
          item_id: item.id,
          unit_price: values[`unit_price_${item.id}`] || 0,
          supplier_name: values[`supplier_name_${item.id}`] || '',
          supplier_contact: values[`supplier_contact_${item.id}`] || '',
          supplier_contact_person: values[`supplier_contact_person_${item.id}`] || '',
          payment_method: values[`payment_method_${item.id}`] || '',
          estimated_delivery: values[`estimated_delivery_${item.id}`] 
            ? values[`estimated_delivery_${item.id}`].format('YYYY-MM-DD') + 'T00:00:00' 
            : undefined
        }))
      };

      // È™åËØÅÊâÄÊúâÂøÖÂ°´È°π
      for (const item of quoteData.items) {
        const itemName = items.find(i => i.id === item.item_id)?.item_name;
        
        if (!item.unit_price || item.unit_price <= 0) {
          message.error(`ËØ∑Â°´ÂÜô ${itemName} ÁöÑÂçï‰ª∑`);
          return;
        }
        if (!item.supplier_name) {
          message.error(`ËØ∑Â°´ÂÜô ${itemName} ÁöÑ‰æõÂ∫îÂïÜ`);
          return;
        }
        if (!item.supplier_contact_person) {
          message.error(`ËØ∑Â°´ÂÜô ${itemName} ÁöÑËÅîÁ≥ª‰∫∫`);
          return;
        }
        if (!item.supplier_contact) {
          message.error(`ËØ∑Â°´ÂÜô ${itemName} ÁöÑËÅîÁ≥ªÊñπÂºè`);
          return;
        }
        if (!item.payment_method) {
          message.error(`ËØ∑ÈÄâÊã© ${itemName} ÁöÑ‰ªòÊ¨æÊñπÂºè`);
          return;
        }
      }

      console.log('üöÄ [React] ÂºÄÂßãÊèê‰∫§ËØ¢‰ª∑Êï∞ÊçÆ:', JSON.stringify(quoteData, null, 2));
      console.log('üîó [React] APIË∞ÉÁî®Âú∞ÂùÄ:', `purchases/${purchaseData.id}/quote`);
      console.log('üîë [React] ÂΩìÂâçtokenÂ≠òÂú®:', !!localStorage.getItem('access_token'));
      await api.post(`purchases/${purchaseData.id}/quote`, quoteData);
      message.success('ËØ¢‰ª∑ÂÆåÊàêÔºåÂ∑≤Êèê‰∫§ÈÉ®Èó®‰∏ªÁÆ°ÂÆ°Êâπ');
      onSuccess();
      onClose();
    } catch (error: any) {
      console.error('üí• [React] ËØ¢‰ª∑Â§±Ë¥•:', error);
      console.error('üîç [React] ÈîôËØØËØ¶ÊÉÖ:', {
        status: error.response?.status,
        statusText: error.response?.statusText,
        data: error.response?.data,
        message: error.message,
        stack: error.stack,
        config: error.config
      });
      
      // ÂàÜÊûêÈîôËØØÁ±ªÂûã
      if (error.response) {
        console.error(`üåê [React] HTTPÈîôËØØ ${error.response.status}: ${error.response.statusText}`);
        console.error('üìã [React] ÊúçÂä°Âô®ÂìçÂ∫î:', error.response.data);
      } else if (error.request) {
        console.error('üö´ [React] ÁΩëÁªúÈîôËØØ: ËØ∑Ê±ÇÂ∑≤ÂèëÈÄÅ‰ΩÜÊ≤°ÊúâÊî∂Âà∞ÂìçÂ∫î');
        console.error('üì° [React] ËØ∑Ê±ÇËØ¶ÊÉÖ:', error.request);
      } else {
        console.error('‚öôÔ∏è [React] ÈÖçÁΩÆÈîôËØØ:', error.message);
      }
      
      message.error(error.response?.data?.detail || error.message || 'ËØ¢‰ª∑Êèê‰∫§Â§±Ë¥•');
    } finally {
      setLoading(false);
    }
  };

  const calculateTotal = (itemId: number, unitPrice: number) => {
    const item = items.find(i => i.id === itemId);
    return item ? (unitPrice * item.quantity).toFixed(2) : '0.00';
  };

  const getTotalAmount = () => {
    let total = 0;
    items.forEach(item => {
      const unitPrice = form.getFieldValue(`unit_price_${item.id}`) || 0;
      total += unitPrice * item.quantity;
    });
    return total.toFixed(2);
  };

  const columns = [
    {
      title: 'Áâ©ÊñôÂêçÁß∞',
      dataIndex: 'item_name',
      width: 200,
      render: (text: string, record: PurchaseItem) => (
        <div>
          <Text strong>{text}</Text>
          <br />
          <Text type="secondary" style={{ fontSize: '12px' }}>
            {record.specification}
          </Text>
        </div>
      )
    },
    {
      title: 'ÂìÅÁâå',
      dataIndex: 'brand',
      width: 100
    },
    {
      title: 'Êï∞Èáè',
      width: 80,
      render: (record: PurchaseItem) => `${record.quantity} ${record.unit}`
    },
    {
      title: 'Âçï‰ª∑(ÂÖÉ)',
      width: 120,
      render: (record: PurchaseItem) => (
        <Form.Item
          name={`unit_price_${record.id}`}
          style={{ margin: 0 }}
          rules={[
            { required: true, message: 'ËØ∑Â°´ÂÜôÂçï‰ª∑' },
            { type: 'number', min: 0.01, message: 'Âçï‰ª∑ÂøÖÈ°ªÂ§ß‰∫é0' }
          ]}
        >
          <InputNumber
            placeholder="Âçï‰ª∑"
            style={{ width: '100%' }}
            min={0.01}
            precision={2}
            onChange={() => form.validateFields()}
          />
        </Form.Item>
      )
    },
    {
      title: 'ÊÄª‰ª∑(ÂÖÉ)',
      width: 120,
      render: (record: PurchaseItem) => {
        const unitPrice = form.getFieldValue(`unit_price_${record.id}`) || 0;
        return (
          <Text strong style={{ color: '#1890ff' }}>
            ¬•{calculateTotal(record.id, unitPrice)}
          </Text>
        );
      }
    },
    {
      title: '‰æõÂ∫îÂïÜ',
      width: 150,
      render: (record: PurchaseItem) => (
        <Form.Item
          name={`supplier_name_${record.id}`}
          style={{ margin: 0 }}
          rules={[{ required: true, message: 'ËØ∑Â°´ÂÜô‰æõÂ∫îÂïÜ' }]}
        >
          <Input placeholder="‰æõÂ∫îÂïÜÂêçÁß∞" />
        </Form.Item>
      )
    },
    {
      title: 'ËÅîÁ≥ª‰∫∫',
      width: 100,
      render: (record: PurchaseItem) => (
        <Form.Item
          name={`supplier_contact_person_${record.id}`}
          style={{ margin: 0 }}
          rules={[{ required: true, message: 'ËØ∑Â°´ÂÜôËÅîÁ≥ª‰∫∫' }]}
        >
          <Input placeholder="ËÅîÁ≥ª‰∫∫ÂßìÂêç" />
        </Form.Item>
      )
    },
    {
      title: 'ËÅîÁ≥ªÊñπÂºè',
      width: 120,
      render: (record: PurchaseItem) => (
        <Form.Item
          name={`supplier_contact_${record.id}`}
          style={{ margin: 0 }}
          rules={[{ required: true, message: 'ËØ∑Â°´ÂÜôËÅîÁ≥ªÊñπÂºè' }]}
        >
          <Input placeholder="ËÅîÁ≥ªÁîµËØù" />
        </Form.Item>
      )
    },
    {
      title: '‰ªòÊ¨æÊñπÂºè',
      width: 120,
      render: (record: PurchaseItem) => (
        <Form.Item
          name={`payment_method_${record.id}`}
          style={{ margin: 0 }}
          rules={[{ required: true, message: 'ËØ∑Â°´ÂÜô‰ªòÊ¨æÊñπÂºè' }]}
        >
          <Input placeholder="Â¶ÇÔºöÊúàÁªì30Â§©" />
        </Form.Item>
      )
    },
    {
      title: 'È¢ÑËÆ°Âà∞Ë¥ß',
      width: 130,
      render: (record: PurchaseItem) => (
        <Form.Item
          name={`estimated_delivery_${record.id}`}
          style={{ margin: 0 }}
        >
          <DatePicker 
            placeholder="ÈÄâÊã©Êó•Êúü"
            style={{ width: '100%' }}
            disabledDate={(current) => current && current < dayjs().startOf('day')}
          />
        </Form.Item>
      )
    }
  ];

  return (
    <Modal
      title={
        <Space>
          <DollarOutlined />
          <span>Áî≥Ë¥≠ÂçïËØ¢‰ª∑ - {purchaseData?.request_code}</span>
        </Space>
      }
      visible={visible}
      onCancel={onClose}
      width={1400}
      footer={[
        <Button key="cancel" onClick={onClose}>
          ÂèñÊ∂à
        </Button>,
        <Button key="submit" type="primary" loading={loading} onClick={handleSubmit}>
          Êèê‰∫§ËØ¢‰ª∑
        </Button>
      ]}
    >
      <Form
        form={form}
        layout="vertical"
        onValuesChange={() => {
          // Ëß¶ÂèëÊÄª‰ª∑ÈáçÊñ∞ËÆ°ÁÆó
        }}
      >
        {/* Áî≥Ë¥≠ÂçïÂü∫Êú¨‰ø°ÊÅØ */}
        <Card size="small" style={{ marginBottom: 16 }}>
          <Row gutter={16}>
            <Col span={6}>
              <Text strong>Áî≥Ë¥≠ÂçïÂè∑Ôºö</Text>
              <Text>{purchaseData?.request_code}</Text>
            </Col>
            <Col span={6}>
              <Text strong>È°πÁõÆÔºö</Text>
              <Text>{purchaseData?.project_name}</Text>
            </Col>
            <Col span={6}>
              <Text strong>Áî≥ËØ∑‰∫∫Ôºö</Text>
              <Text>{purchaseData?.requester_name}</Text>
            </Col>
            <Col span={6}>
              <Text strong>Áî≥ËØ∑Êó•ÊúüÔºö</Text>
              <Text>{dayjs(purchaseData?.request_date).format('YYYY-MM-DD')}</Text>
            </Col>
          </Row>
        </Card>

        {/* Áî≥Ë¥≠ÊòéÁªÜË°®Ê†º */}
        <div style={{ marginBottom: 16 }}>
          <Title level={5}>Áî≥Ë¥≠ÊòéÁªÜ</Title>
          <Table
            columns={columns}
            dataSource={items}
            rowKey="id"
            pagination={false}
            scroll={{ x: 1300 }}
            size="small"
            bordered
          />
        </div>

        {/* ÊÄª‰ª∑ÊòæÁ§∫ */}
        <Card size="small" style={{ marginBottom: 16, backgroundColor: '#f0f2f5' }}>
          <Row justify="end">
            <Col>
              <Text strong style={{ fontSize: '16px', color: '#1890ff' }}>
                <DollarOutlined /> ÊÄªÈáëÈ¢ùÔºö¬•{getTotalAmount()}
              </Text>
            </Col>
          </Row>
        </Card>

        <Divider />

        <Form.Item
          label="ËØ¢‰ª∑Â§áÊ≥®"
          name="quote_notes"
        >
          <TextArea
            placeholder="ËØ∑Â°´ÂÜôËØ¢‰ª∑Â§áÊ≥®‰ø°ÊÅØ..."
            rows={3}
            maxLength={500}
            showCount
          />
        </Form.Item>
      </Form>
    </Modal>
  );
};

export default PurchaseQuoteForm;